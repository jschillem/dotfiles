#!/usr/bin/env zsh

# nts - New Tmux Session
# Creates a new tmux session with optional name or auto-incremented number

set -euo pipefail

# Color codes for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m' # No Color

# Script metadata
readonly SCRIPT_NAME="${0:t}"
readonly VERSION="1.0.1"

# Function to print colored messages
print_error() {
    print -P "%F{red}✗%f $1" >&2
}

print_success() {
    print -P "%F{green}✓%f $1"
}

print_warning() {
    print -P "%F{yellow}⚠ %f $1"
}

print_info() {
    print -P "%F{blue}ℹ%f $1"
}

# Function to display usage
usage() {
    cat <<EOF
Usage: ${SCRIPT_NAME} [OPTIONS] [SESSION_NAME]

Create a new tmux session with optional name or auto-incremented number.

OPTIONS:
    -h, --help      Show this help message
    -v, --version   Show version information
    -d, --detached  Create session without attaching to it
    -c, --command   Initial command to run in the session
    -w, --window    Window name(s) to create. Can be used multiple times
                    or with comma-separated values

ARGUMENTS:
    SESSION_NAME    Optional name for the new session.
                    If omitted, uses auto-incremented number.

EXAMPLES:
    ${SCRIPT_NAME}              # Create session with auto-incremented number
    ${SCRIPT_NAME} work         # Create session named 'work'
    ${SCRIPT_NAME} -d project   # Create detached session named 'project'
    ${SCRIPT_NAME} -c "vim" dev # Create 'dev' session and run vim
    ${SCRIPT_NAME} -w editor -w terminal dev  # Create 'dev' with two windows
    ${SCRIPT_NAME} -w editor,terminal,logs    # Create session with three windows

EOF
}

# Function to check if tmux is installed
check_tmux() {
    if ! command -v tmux &>/dev/null; then
        print_error "tmux is not installed or not in PATH"
        exit 1
    fi
}

# Function to get list of existing session names
get_session_names() {
    tmux list-sessions -F '#{session_name}' 2>/dev/null || true
}

# Function to check if session exists
session_exists() {
    local session_name="$1"
    tmux has-session -t "${session_name}" 2>/dev/null
}

# Function to find next available numbered session
find_next_number() {
    local existing_sessions
    local existing_numbers=()
    
    # Get all existing sessions
    existing_sessions=(${(f)"$(get_session_names)"})
    
    # Extract numeric session names
    for session in ${existing_sessions[@]}; do
        if [[ "${session}" =~ ^[0-9]+$ ]]; then
            existing_numbers+=(${session})
        fi
    done
    
    # If no numeric sessions exist, start with 1
    if [[ ${#existing_numbers[@]} -eq 0 ]]; then
        echo "1"
        return
    fi
    
    # Sort numbers and find the first gap or next number
    existing_numbers=(${(on)existing_numbers[@]})
    
    # Look for gaps in sequence
    local next_num=1
    for num in ${existing_numbers[@]}; do
        if [[ ${num} -ne ${next_num} ]]; then
            echo "${next_num}"
            return
        fi
        ((next_num++))
    done
    
    # No gaps found, use next number after highest
    echo "${next_num}"
}

# Function to create session
create_session() {
    local session_name="$1"
    local detached="$2"
    local initial_command="$3"
    shift 3
    local -a window_names=("$@")
    
    local tmux_args=()
    
    # Build tmux command arguments for initial session
    tmux_args+=("new-session")
    
    # Always create detached first, then attach if needed (to ensure proper window creation)
    tmux_args+=("-d")
    
    tmux_args+=("-s" "${session_name}")
    
    # Set name for first window if provided
    if [[ ${#window_names[@]} -gt 0 ]] && [[ -n "${window_names[1]}" ]]; then
        tmux_args+=("-n" "${window_names[1]}")
    fi
    
    if [[ -n "${initial_command}" ]]; then
        tmux_args+=("${initial_command}")
    fi
    
    # Create the session
    if ! tmux "${tmux_args[@]}" 2>/dev/null; then
        return 1
    fi
    
    # Create additional windows if specified
    if [[ ${#window_names[@]} -gt 1 ]]; then
        # Small delay to ensure session is fully created
        sleep 0.1
        
        # Loop through remaining windows starting from index 2
        for ((i=2; i<=${#window_names[@]}; i++)); do
            local window_name="${window_names[i]}"
            if [[ -n "${window_name}" ]]; then
                # Use -d flag to create window in background and ensure session exists
                if tmux new-window -d -t "${session_name}:" -n "${window_name}" 2>/dev/null; then
                    : # Success - do nothing
                else
                    print_warning "Failed to create window: ${window_name}"
                fi
            fi
        done
        
        # Make sure we're on the first window
        tmux select-window -t "${session_name}:1" 2>/dev/null || true
    fi
    
    # Now attach if not detached mode
    if [[ "${detached}" == "false" ]]; then
        # Attach to the session
        tmux attach-session -t "${session_name}" 2>/dev/null || {
            print_error "Failed to attach to session '${session_name}'"
            return 1
        }
    else
        print_success "Created detached session: ${session_name}"
        if [[ ${#window_names[@]} -gt 0 ]]; then
            print_info "Windows created: ${(j:, :)window_names}"
        fi
        print_info "Attach with: ta ${session_name}"
    fi
    
    return 0
}

# Main function
main() {
    local session_name=""
    local detached="false"
    local initial_command=""
    local -a window_names=()
    
    # Parse command line arguments
    local -a positional_args=()
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            -v|--version)
                print "Version ${VERSION}"
                exit 0
                ;;
            -d|--detached)
                detached="true"
                shift
                ;;
            -c|--command)
                if [[ -z "${2:-}" ]]; then
                    print_error "Option -c requires an argument"
                    exit 1
                fi
                initial_command="$2"
                shift 2
                ;;
            -w|--window)
                if [[ -z "${2:-}" ]]; then
                    print_error "Option -w requires an argument"
                    exit 1
                fi
                # Split comma-separated values and add to array
                # Use parameter expansion to split on commas
                local -a new_windows=("${(@s:,:)2}")
                for window in "${new_windows[@]}"; do
                    # Trim whitespace from window name
                    window="${window#"${window%%[![:space:]]*}"}"
                    window="${window%"${window##*[![:space:]]}"}"
                    if [[ -n "${window}" ]]; then
                        window_names+=("${window}")
                    fi
                done
                shift 2
                ;;
            -*)
                print_error "Unknown option: $1"
                usage
                exit 1
                ;;
            *)
                positional_args+=("$1")
                shift
                ;;
        esac
    done
    
    # Check if tmux is available
    check_tmux
    
    # Handle positional arguments
    if [[ ${#positional_args[@]} -gt 1 ]]; then
        print_error "Too many arguments provided"
        usage
        exit 1
    elif [[ ${#positional_args[@]} -eq 1 ]]; then
        session_name="${positional_args[1]}"
    fi
    
    # If no session name provided, use auto-increment
    if [[ -z "${session_name}" ]]; then
        session_name=$(find_next_number)
        print_info "Using auto-incremented session name: ${session_name}"
    fi
    
    # Validate session name
    if [[ ! "${session_name}" =~ ^[a-zA-Z0-9_.-]+$ ]]; then
        print_error "Invalid session name: ${session_name}"
        print_info "Session names can only contain alphanumeric characters, dots, underscores, and hyphens"
        exit 1
    fi
    
    # Check if session already exists
    if session_exists "${session_name}"; then
        print_error "Session '${session_name}' already exists"
        print_info "Use 'ta ${session_name}' to attach to it"
        exit 1
    fi
    
    # Check if we're already in a tmux session (warn but don't prevent)
    if [[ -n "${TMUX:-}" ]] && [[ "${detached}" == "false" ]]; then
        print_warning "Already inside a tmux session. Creating new session will nest sessions."
        print_info "Consider using -d flag to create a detached session instead."
        print -n "Continue? [y/N]: "
        read -r response
        if [[ ! "${response}" =~ ^[Yy]$ ]]; then
            print_info "Operation cancelled"
            exit 0
        fi
    fi
    
    # Create the session
    if ! create_session "${session_name}" "${detached}" "${initial_command}" "${window_names[@]}"; then
        print_error "Failed to create session '${session_name}'"
        exit 1
    fi
}

# Run main function
main "$@"
